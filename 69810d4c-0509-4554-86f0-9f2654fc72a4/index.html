<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Editor</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --border: #333;
            --accent: #007acc;
            --text: #cccccc;
            --menu-bg: #252526;
            --menu-hover: #37373d;
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: var(--bg-dark); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        header { height: 50px; background: #333; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #000; justify-content: space-between; }
        h1 { font-size: 16px; margin: 0; color: #fff; }
        .toolbar button { background: var(--accent); border: none; color: white; padding: 6px 12px; cursor: pointer; border-radius: 3px; font-size: 13px; margin-left: 10px; }
        .toolbar button.secondary { background: #444; }
        .toolbar button:hover { opacity: 0.9; }

        /* MAIN LAYOUT */
        .workspace { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .file-controls { padding: 10px; border-bottom: 1px solid var(--border); display: flex; gap: 5px; }
        .file-controls input { background: #3c3c3c; border: 1px solid #555; color: white; padding: 4px; width: 100%; border-radius: 3px; }
        .file-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        
        /* FILE ITEMS */
        .file-item { padding: 5px 15px; cursor: pointer; display: flex; align-items: center; font-size: 13px; user-select: none; }
        .file-item:hover { background: #2a2d2e; }
        .file-item.active { background: #37373d; color: white; border-left: 2px solid var(--accent); }
        .file-item .del-btn { margin-left: auto; color: #aaa; cursor: pointer; font-size: 16px; display: none; }
        .file-item:hover .del-btn { display: block; }
        .folder-label { padding: 5px 10px; font-weight: bold; color: #888; font-size: 12px; text-transform: uppercase; margin-top: 5px;}
        
        /* Tree View Styles */
        ul.tree-root, ul.nested-group { list-style: none; padding: 0; margin: 0; }
        ul.nested-group { padding-left: 15px; display: none; } /* Hidden by default */
        ul.nested-group.expanded { display: block; } /* Show when expanded */

        .folder-item { cursor: pointer; padding: 5px 10px; color: #aaa; font-size: 13px; font-weight: bold; display: flex; align-items: center; user-select: none; }
        .folder-item:hover { color: #fff; }
        .folder-icon { display: inline-block; width: 15px; font-size: 10px; transition: transform 0.2s; }
        .folder-item.open .folder-icon { transform: rotate(90deg); }

        .file-item { padding-left: 24px; } /* Align files with folder text */

        /* EDITOR AREA */
        .editor-container { flex: 1; position: relative; }
        #monaco-root { width: 100%; height: 100%; }

        /* PREVIEW AREA */
        .preview-container { width: 40%; background: white; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .preview-header { padding: 5px 10px; background: #eee; color: #333; font-size: 12px; border-bottom: 1px solid #ccc; font-weight: bold; }
        iframe { flex: 1; border: none; width: 100%; height: 100%; background: #fff; }

        /* CONTEXT MENU */
        #context-menu {
            position: fixed;
            z-index: 10000;
            width: 150px;
            background: var(--menu-bg);
            border: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            display: none;
            padding: 5px 0;
            border-radius: 4px;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text);
            display: flex;
            align-items: center;
        }
        .context-menu-item:hover {
            background: var(--menu-hover);
            color: #fff;
        }

    </style>
</head>
<body>

<header>
    <h1>Project Editor</h1>
    <div class="toolbar" style="display: flex; align-items: center; gap: 10px;">
        <div class="project-selector" style="display: flex; align-items: center; gap: 5px; background: #444; padding: 2px 8px; border-radius: 4px;">
            <span style="font-size: 12px; color: #aaa;">Project:</span>
            <select id="projectSelect" onchange="editorApp.switchProject(this.value)" style="background: transparent; color: white; border: none; font-size: 13px; outline: none; cursor: pointer;">
            </select>
            <button class="secondary" onclick="editorApp.createNewProject()" style="background: none; border: none; padding: 0 5px; margin: 0; font-size: 16px;" title="New Project">+</button>
            <button class="secondary" onclick="editorApp.deleteCurrentProject()" style="background: none; border: none; padding: 0 5px; margin: 0; font-size: 12px; color: #f44336;" title="Delete Project">ðŸ—‘</button>
        </div>
        <button class="secondary" onclick="editorApp.formatCode()">Format Code</button>
        <button onclick="editorApp.runCode()">â–¶ Run</button>
    </div>
</header>

<div class="workspace">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="file-controls">
            <input type="text" id="newFilename" placeholder="New file (e.g. css/style.css)">
            <button class="secondary" onclick="editorApp.addFile()">+</button>
        </div>
        <div id="fileList" class="file-list"></div>
    </div>

    <!-- Code Editor -->
    <div class="editor-container">
        <div id="monaco-root"></div>
    </div>

    <!-- Output -->
    <div class="preview-container">
        <div class="preview-header">Output (Click Run)</div>
        <iframe id="previewFrame" sandbox="allow-scripts allow-modals"></iframe>
    </div>
</div>

<!-- Context Menu -->
<div id="context-menu">
    <div class="context-menu-item" id="ctx-rename">Rename</div>
    <div class="context-menu-item" id="ctx-delete">Delete</div>
</div>

<!-- Load Monaco Editor from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs/loader.min.js"></script>

<script>
/**
 * APPLICATION LOGIC
 */
const PROJECTS_KEY = 'myCodeEditor_projectList';
const CURRENT_PROJECT_KEY = 'myCodeEditor_currentProject';
const FILES_PREFIX = 'myCodeEditor_files_';

const defaultFiles = {
    'index.html': {
        language: 'html',
        content: `<!DOCTYPE html>
<html>
<head>
    <title>My Page</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <h1>Hello World</h1>
    <button id="btn">Click Me</button>
    <script src="script.js"><\/script>
</body>
</html>`
    },
    'styles/main.css': {
        language: 'css',
        content: `body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
h1 { color: #333; }`
    },
    'script.js': {
        language: 'javascript',
        content: `document.getElementById('btn').addEventListener('click', () => {
    alert('JavaScript is working!');
});`
    }
};

const editorApp = {
    projects: [],
    currentProject: '',
    files: {},
    activeFile: null,
    editorInstance: null,
    expandedFolders: new Set(), 
    contextMenuTarget: null,

    // 1. Initialize
    init: function() {
        this.loadProjects();
        this.initMonaco();
        this.initContextMenu();
    },

    // 2. Project Management
    loadProjects: function() {
        const storedProjects = localStorage.getItem(PROJECTS_KEY);
        if (storedProjects) {
            this.projects = JSON.parse(storedProjects);
        } else {
            this.projects = ['Default Project'];
            localStorage.setItem(PROJECTS_KEY, JSON.stringify(this.projects));
        }

        const storedCurrent = localStorage.getItem(CURRENT_PROJECT_KEY);
        if (storedCurrent && this.projects.includes(storedCurrent)) {
            this.currentProject = storedCurrent;
        } else {
            this.currentProject = this.projects[0];
            localStorage.setItem(CURRENT_PROJECT_KEY, this.currentProject);
        }

        this.updateProjectSelect();
        this.loadFiles();
    },

    updateProjectSelect: function() {
        const select = document.getElementById('projectSelect');
        select.innerHTML = '';
        this.projects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            opt.selected = (p === this.currentProject);
            select.appendChild(opt);
        });
    },

    createNewProject: function() {
        const name = prompt('Enter new project name:');
        if (!name) return;
        if (this.projects.includes(name)) return alert('Project already exists');

        this.saveFiles(); // Save current project first

        this.projects.push(name);
        localStorage.setItem(PROJECTS_KEY, JSON.stringify(this.projects));
        
        // Initialize with default files
        const projectFilesKey = FILES_PREFIX + name;
        localStorage.setItem(projectFilesKey, JSON.stringify(defaultFiles));

        this.switchProject(name);
    },

    deleteCurrentProject: function() {
        if (this.projects.length <= 1) return alert('Cannot delete the last project');
        if (!confirm(`Are you sure you want to delete project "${this.currentProject}"?`)) return;

        localStorage.removeItem(FILES_PREFIX + this.currentProject);
        
        const idx = this.projects.indexOf(this.currentProject);
        this.projects.splice(idx, 1);
        localStorage.setItem(PROJECTS_KEY, JSON.stringify(this.projects));

        this.switchProject(this.projects[0]);
    },

    switchProject: function(projectName) {
        if (this.editorInstance) {
            this.saveFiles();
        }
        this.currentProject = projectName;
        localStorage.setItem(CURRENT_PROJECT_KEY, projectName);
        this.activeFile = null; // Reset active file
        this.loadFiles();
        this.updateProjectSelect();
        
        if (this.editorInstance) {
            const file = this.files[this.activeFile];
            if (file) {
                const model = this.editorInstance.getModel();
                monaco.editor.setModelLanguage(model, file.language);
                this.editorInstance.setValue(file.content);
            } else {
                this.editorInstance.setValue('');
            }
        }
        this.renderSidebar();
    },

    // 3. Storage Management
    loadFiles: function() {
        const key = FILES_PREFIX + this.currentProject;
        const stored = localStorage.getItem(key);
        if (stored) {
            this.files = JSON.parse(stored);
        } else {
            // Check for migration from old single project system
            const oldStored = localStorage.getItem('myCodeEditor_files');
            if (oldStored && this.currentProject === 'Default Project') {
                this.files = JSON.parse(oldStored);
            } else {
                this.files = JSON.parse(JSON.stringify(defaultFiles));
            }
        }
        
        if (!this.activeFile || !this.files[this.activeFile]) {
            this.activeFile = Object.keys(this.files)[0] || 'index.html';
        }
    },

    saveFiles: function() {
        if (this.activeFile && this.editorInstance && this.files[this.activeFile]) {
            this.files[this.activeFile].content = this.editorInstance.getValue();
        }
        const key = FILES_PREFIX + this.currentProject;
        localStorage.setItem(key, JSON.stringify(this.files));
    },

    // 3. Monaco Setup
    initMonaco: function() {
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs' }});
        
        require(['vs/editor/editor.main'], () => {
            if (!this.files[this.activeFile]) {
                this.activeFile = Object.keys(this.files)[0];
            }
            
            this.editorInstance = monaco.editor.create(document.getElementById('monaco-root'), {
                value: this.files[this.activeFile] ? this.files[this.activeFile].content : '',
                language: this.files[this.activeFile] ? this.files[this.activeFile].language : 'plaintext',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false },
                fontSize: 14
            });

            // Save on typing
            this.editorInstance.onDidChangeModelContent(() => {
                if (this.activeFile && this.files[this.activeFile]) {
                    this.files[this.activeFile].content = this.editorInstance.getValue();
                    this.saveFiles(); // Auto-save to localstorage
                }
            });

            this.renderSidebar();
        });
    },

    // 4. File Management
    addFile: function() {
        const input = document.getElementById('newFilename');
        const name = input.value.trim();
        
        if (!name) return alert('Enter a filename');
        if (this.files[name]) return alert('File already exists');

        this.files[name] = {
            language: this.getLanguageFromFilename(name),
            content: ''
        };

        input.value = '';
        this.switchFile(name);
        this.renderSidebar();
        this.saveFiles();
    },

    getLanguageFromFilename: function(name) {
        if (name.endsWith('.html')) return 'html';
        if (name.endsWith('.css')) return 'css';
        if (name.endsWith('.js')) return 'javascript';
        if (name.endsWith('.json')) return 'json';
        return 'plaintext';
    },

    deleteFile: function(name) {
        if(!confirm(`Delete ${name}?`)) return;
        
        delete this.files[name];
        
        if (this.activeFile === name) {
            this.activeFile = Object.keys(this.files)[0] || null;
            if(this.activeFile) this.switchFile(this.activeFile);
            else if (this.editorInstance) this.editorInstance.setValue('');
        }
        
        this.renderSidebar();
        this.saveFiles();
    },

    renameFile: function(oldName) {
        const newName = prompt(`Rename ${oldName} to:`, oldName);
        if (!newName || newName === oldName) return;
        if (this.files[newName]) return alert('File already exists');

        this.files[newName] = this.files[oldName];
        this.files[newName].language = this.getLanguageFromFilename(newName);
        delete this.files[oldName];

        if (this.activeFile === oldName) {
            this.activeFile = newName;
        }

        this.renderSidebar();
        this.saveFiles();
    },

    switchFile: function(filename) {
        this.activeFile = filename;
        const file = this.files[filename];
        
        // Update Editor
        if (this.editorInstance && file) {
            const model = this.editorInstance.getModel();
            monaco.editor.setModelLanguage(model, file.language);
            this.editorInstance.setValue(file.content);
        }

        this.renderSidebar();
    },

    // 5. Sidebar Rendering
    renderSidebar: function() {
        const list = document.getElementById('fileList');
        list.innerHTML = '';

        const tree = {};
        Object.keys(this.files).sort().forEach(path => {
            const parts = path.split('/');
            let current = tree;
            parts.forEach((part, i) => {
                if (!current[part]) {
                    current[part] = (i === parts.length - 1) 
                        ? { __type: 'file', fullPath: path } 
                        : { __type: 'folder', children: {} };
                }
                current = current[part].children || current[part];
            });
        });

        const createTreeHTML = (node, container, currentPathString = '') => {
            const entries = Object.entries(node).sort((a, b) => {
                if (a[1].__type !== b[1].__type) return a[1].__type === 'folder' ? -1 : 1;
                return a[0].localeCompare(b[0]);
            });

            entries.forEach(([name, data]) => {
                if (data.__type === 'folder') {
                    const folderPath = currentPathString ? `${currentPathString}/${name}` : name;
                    const isOpen = this.expandedFolders.has(folderPath);

                    const li = document.createElement('li');
                    const title = document.createElement('div');
                    title.className = `folder-item ${isOpen ? 'open' : ''}`;
                    title.innerHTML = `<span class="folder-icon">â–¶</span> ${name}`;
                    title.onclick = () => {
                        if (this.expandedFolders.has(folderPath)) this.expandedFolders.delete(folderPath);
                        else this.expandedFolders.add(folderPath);
                        this.renderSidebar();
                    };

                    const ul = document.createElement('ul');
                    ul.className = `nested-group ${isOpen ? 'expanded' : ''}`;
                    
                    li.appendChild(title);
                    li.appendChild(ul);
                    container.appendChild(li);

                    createTreeHTML(data.children, ul, folderPath);

                } else {
                    const li = document.createElement('li');
                    li.className = `file-item ${data.fullPath === this.activeFile ? 'active' : ''}`;
                    li.innerHTML = `
                        <span>${name}</span>
                        <span class="del-btn">Ã—</span>
                    `;
                    li.onclick = () => this.switchFile(data.fullPath);
                    li.querySelector('.del-btn').onclick = (e) => {
                        e.stopPropagation();
                        this.deleteFile(data.fullPath);
                    };
                    
                    // Add context menu listener
                    li.oncontextmenu = (e) => {
                        e.preventDefault();
                        this.showContextMenu(e, data.fullPath);
                    };

                    container.appendChild(li);
                }
            });
        };

        const rootUl = document.createElement('ul');
        rootUl.className = 'tree-root';
        createTreeHTML(tree, rootUl);
        list.appendChild(rootUl);
    },

    // 6. Context Menu Logic
    initContextMenu: function() {
        const menu = document.getElementById('context-menu');
        
        window.addEventListener('click', () => {
            this.hideContextMenu();
        });

        document.getElementById('ctx-rename').onclick = () => {
            if (this.contextMenuTarget) {
                this.renameFile(this.contextMenuTarget);
            }
        };

        document.getElementById('ctx-delete').onclick = () => {
            if (this.contextMenuTarget) {
                this.deleteFile(this.contextMenuTarget);
            }
        };
    },

    showContextMenu: function(e, filename) {
        const menu = document.getElementById('context-menu');
        this.contextMenuTarget = filename;
        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    },

    hideContextMenu: function() {
        const menu = document.getElementById('context-menu');
        menu.style.display = 'none';
    },

    // 7. Formatting Code
    formatCode: function() {
        if(this.editorInstance) {
            this.editorInstance.getAction('editor.action.formatDocument').run();
        }
    },

    // 8. RUN LOGIC
    runCode: function() {
        const iframe = document.getElementById('previewFrame');
        let htmlContent = this.files['index.html'] ? this.files['index.html'].content : '<h1>No index.html found</h1>';

        const createBlob = (content, type) => {
            const blob = new Blob([content], { type });
            return URL.createObjectURL(blob);
        };

        // Replace CSS Links
        htmlContent = htmlContent.replace(/<link[^>]+href="([^"]+)"[^>]*>/g, (match, href) => {
            if (this.files[href]) {
                const blobUrl = createBlob(this.files[href].content, 'text/css');
                return match.replace(href, blobUrl);
            }
            return match;
        });

        // Replace JS Scripts
        htmlContent = htmlContent.replace(/<script[^>]+src="([^"]+)"[^>]*><\/script>/g, (match, src) => {
            if (this.files[src]) {
                const blobUrl = createBlob(this.files[src].content, 'text/javascript');
                return match.replace(src, blobUrl);
            }
            return match;
        });

        iframe.srcdoc = htmlContent;
    }
};

// Start the app
editorApp.init();

</script>

</body>
</html>
